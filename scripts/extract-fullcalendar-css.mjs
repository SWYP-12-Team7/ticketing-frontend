/**
 * Extracts FullCalendar CSS from the global bundles shipped in node_modules.
 *
 * Why:
 * - This repo currently uses FullCalendar ESM packages that do NOT ship standalone CSS files.
 * - However, the `index.global.js` bundles embed the official CSS as a string and inject it at runtime.
 * - Bundlers may tree-shake those global bundles (package marks `sideEffects: false`), causing layout to look broken.
 *
 * What:
 * - We extract the embedded CSS strings and vendor them into `app/vendor/fullcalendar/*.css`,
 *   then import them from `app/globals.css` like normal global CSS.
 *
 * Run:
 *   node scripts/extract-fullcalendar-css.mjs
 */

import fs from "node:fs";
import path from "node:path";
import vm from "node:vm";

const ROOT = process.cwd();

const SOURCES = [
  {
    pkg: "@fullcalendar/core",
    input: "node_modules/@fullcalendar/core/index.global.js",
    output: "app/vendor/fullcalendar/core.css",
  },
  {
    pkg: "@fullcalendar/daygrid",
    input: "node_modules/@fullcalendar/daygrid/index.global.js",
    output: "app/vendor/fullcalendar/daygrid.css",
  },
];

function readText(p) {
  return fs.readFileSync(p, "utf8");
}

function writeText(p, text) {
  fs.mkdirSync(path.dirname(p), { recursive: true });
  fs.writeFileSync(p, text, "utf8");
}

function extractCssStringLiteral(bundleSource) {
  // We want the first `var css_xxx = "....";` assignment.
  // The string itself is a JS string literal with escaped quotes/newlines etc.
  const m = bundleSource.match(/var\s+css_[A-Za-z0-9_]+\s*=\s*(\"(?:\\.|[^\"\\])*\")\s*;/);
  if (!m) return null;
  return m[1];
}

function evalStringLiteral(strLiteral) {
  // Evaluate in a safe sandbox. The literal is something like "....".
  return vm.runInNewContext(strLiteral, Object.create(null), { timeout: 1000 });
}

function normalizeNewlines(s) {
  return String(s).replace(/\r\n/g, "\n");
}

function banner({ pkg, input }) {
  return [
    "/*",
    `  Generated by scripts/extract-fullcalendar-css.mjs`,
    `  Source: ${input}`,
    `  Package: ${pkg}`,
    `  GeneratedAt: ${new Date().toISOString()}`,
    "*/",
    "",
  ].join("\n");
}

for (const src of SOURCES) {
  const inputAbs = path.join(ROOT, src.input);
  const outAbs = path.join(ROOT, src.output);

  const js = readText(inputAbs);
  const literal = extractCssStringLiteral(js);
  if (!literal) {
    throw new Error(`Failed to find embedded CSS literal in ${src.input}`);
  }

  const css = normalizeNewlines(evalStringLiteral(literal));
  writeText(outAbs, banner(src) + css + "\n");
  console.log(`âœ“ wrote ${src.output} (${css.length.toLocaleString()} chars)`);
}

